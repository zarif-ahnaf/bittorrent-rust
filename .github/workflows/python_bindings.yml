# This file is autogenerated by maturin v1.10.2
# To update, run
#
#    maturin generate-ci github
#
name: Python Bindings

on:
    push:
        branches:
            - main
            - master
        tags:
            - '*'
    pull_request:
    workflow_dispatch:

permissions:
    contents: read

jobs:
    linux:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: ubuntu-latest
                      target: x86_64
                    - runner: ubuntu-latest
                      target: x86
                    - runner: ubuntu-latest
                      target: aarch64
                    - runner: ubuntu-latest
                      target: armv7
                    - runner: ubuntu-latest
                      target: s390x
                    - runner: ubuntu-latest
                      target: ppc64le
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x

            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
                  manylinux: auto
                  working-directory: crates/python_bindings

            - name: Install test dependencies
              run: pip install pytest

            - name: Install built wheel
              run: pip install dist/*.whl

            - name: Run pytest
              run: pytest -q

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-linux-${{ matrix.platform.target }}
                  path: dist

    musllinux:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: ubuntu-latest
                      target: x86_64
                    - runner: ubuntu-latest
                      target: x86
                    - runner: ubuntu-latest
                      target: aarch64
                    - runner: ubuntu-latest
                      target: armv7
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x

            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
                  manylinux: musllinux_1_2
                  working-directory: crates/python_bindings

            - name: Install test dependencies
              run: pip install pytest

            - name: Install built wheel
              run: pip install dist/*.whl

            - name: Run pytest
              run: pytest -q

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-musllinux-${{ matrix.platform.target }}
                  path: dist

    windows:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: windows-latest
                      target: x64
                    - runner: windows-latest
                      target: x86
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x
                  architecture: ${{ matrix.platform.target }}

            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
                  working-directory: crates/python_bindings

            - name: Install test dependencies
              run: pip install pytest

            - name: Install built wheel
              run: pip install dist/*.whl

            - name: Run pytest
              run: pytest -q

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-windows-${{ matrix.platform.target }}
                  path: dist

    macos:
        runs-on: ${{ matrix.platform.runner }}
        strategy:
            matrix:
                platform:
                    - runner: macos-13
                      target: x86_64
                    - runner: macos-14
                      target: aarch64
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: 3.x

            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.platform.target }}
                  args: --release --out dist --find-interpreter
                  sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
                  working-directory: crates/python_bindings

            - name: Install test dependencies
              run: pip install pytest

            - name: Install built wheel
              run: pip install dist/*.whl

            - name: Run pytest
              run: pytest -q

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-macos-${{ matrix.platform.target }}
                  path: dist

    sdist:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Build sdist
              uses: PyO3/maturin-action@v1
              with:
                  command: sdist
                  args: --out dist
                  working-directory: crates/python_bindings

            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-sdist
                  path: dist

    release:
        name: Release
        runs-on: ubuntu-latest
        if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' }}
        needs: [linux, musllinux, windows, macos, sdist]
        permissions:
            id-token: write
            contents: write
            attestations: write

        steps:
            - uses: actions/download-artifact@v4

            - name: Generate artifact attestation
              uses: actions/attest-build-provenance@v2
              with:
                  subject-path: 'wheels-*/*'

            - name: Publish to PyPI
              if: ${{ startsWith(github.ref, 'refs/tags/') }}
              uses: PyO3/maturin-action@v1
              env:
                  MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
              with:
                  command: upload
                  args: --non-interactive --skip-existing wheels-*/*
                  working-directory: crates/python_bindings
